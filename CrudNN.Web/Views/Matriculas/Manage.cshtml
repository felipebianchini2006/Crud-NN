@using System.Linq
@using Microsoft.AspNetCore.Mvc.Rendering
@model MatriculaGerenciarViewModel
@{
    ViewData["Title"] = "Gerenciar matrículas";
    var alunos = ViewBag.Alunos as SelectList ?? new SelectList(Enumerable.Empty<SelectListItem>());
}

<h1 class="h3 mb-3">Gerenciar matrículas</h1>

<form method="get" class="row gy-2 gx-2 align-items-end mb-4">
    <div class="col-md-6">
        <label class="form-label" for="alunoId">Aluno</label>
        @Html.DropDownList("alunoId", alunos, "Selecione um aluno", new { @class = "form-select" })
    </div>
    <div class="col-md-auto">
        <button type="submit" class="btn btn-outline-secondary">Carregar</button>
    </div>
</form>

@if (Model.AlunoId == 0)
{
    <p class="text-muted">Selecione um aluno para visualizar e atualizar suas matrículas.</p>
}
else
{
    <h2 class="h5 mb-3">@Model.AlunoNome</h2>
    <form asp-action="Manage" method="post">
        <input type="hidden" asp-for="AlunoId" />
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
        <div class="table-responsive">
            <table class="table table-striped align-middle">
                <thead>
                <tr>
                    <th style="width: 220px;">Curso</th>
                    <th style="width: 110px;">Matricular</th>
                    <th>Preço pago</th>
                    <th>Progresso</th>
                    <th>Status</th>
                    <th>Nota final</th>
                    <th>Última atualização</th>
                </tr>
                </thead>
                <tbody>
                @for (var i = 0; i < Model.Cursos.Count; i++)
                {
                    <tr>
                        <td>
                            @Model.Cursos[i].Titulo
                            <input type="hidden" asp-for="Cursos[@i].CursoId" />
                            <input type="hidden" asp-for="Cursos[@i].Titulo" />
                            <input type="hidden" asp-for="Cursos[@i].PrecoBase" />
                            <input type="hidden" asp-for="Cursos[@i].Data" />
                        </td>
                        <td>
                            <div class="form-check">
                                <input class="form-check-input" asp-for="Cursos[@i].Selecionado" />
                                <label class="form-check-label" asp-for="Cursos[@i].Selecionado">Incluir</label>
                            </div>
                        </td>
                        <td>
                            <input asp-for="Cursos[@i].PrecoPago" class="form-control" type="number" step="0.01" min="0" />
                            <div class="form-text">Base: @Model.Cursos[i].PrecoBase.ToString("C2")</div>
                            <span asp-validation-for="Cursos[@i].PrecoPago" class="text-danger"></span>
                        </td>
                        <td>
                            <input asp-for="Cursos[@i].Progresso" class="form-control" type="number" min="0" max="100" />
                            <span asp-validation-for="Cursos[@i].Progresso" class="text-danger"></span>
                        </td>
                        <td>
                            <select asp-for="Cursos[@i].Status" class="form-select" asp-items="Html.GetEnumSelectList<MatriculaStatus>()"></select>
                        </td>
                        <td>
                            <input asp-for="Cursos[@i].NotaFinal" class="form-control" type="number" step="0.1" min="0" max="10" />
                            <span asp-validation-for="Cursos[@i].NotaFinal" class="text-danger"></span>
                        </td>
                        <td>
                            @(Model.Cursos[i].Data?.ToLocalTime().ToString("dd/MM/yyyy HH:mm") ?? "-")
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
        <p class="text-muted">Status "Concluido" requer progresso 100%. Nota final é opcional.</p>
        <div class="d-flex justify-content-between">
            <a class="btn btn-link" asp-action="Index">Voltar</a>
            <button type="submit" class="btn btn-primary">Salvar alterações</button>
        </div>
    </form>
}

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
